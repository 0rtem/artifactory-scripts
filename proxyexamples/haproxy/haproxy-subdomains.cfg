frontend normal
    bind *:443 ssl crt /usr/local/etc/haproxy/ssl/my-cert.pem
    mode http
    option forwardfor
    acl is_docker_request path_beg -i /v2/
    http-request set-var(req.subdomain) req.hdr(host),lower,regsub(\.artifactory\.test\.com$,) if { hdr_end(host) -i .artifactory.test.com }
    http-request set-header X-Artifactory-Override-Base-Url https://%[hdr(host)]/artifactory
    http-request set-path /artifactory/api/docker/%[var(req.subdomain)]%[path] if is_docker_request
    reqadd X-Forwarded-Proto:\ https
    option forwardfor header X-Real-IP
    default_backend normal

backend normal
    mode http
    server primary 10.6.7.8:8081
    server secondary 10.7.8.9:8081

frontend normal
     bind *:80

     bind *:443 ssl crt /etc/haproxy/ssl

     mode http

     option forwarder

     reqadd X-Forwarded-Proto:\ https if { ssl_fc }

     option forwardfor header X-Real-IP

     acl n hdr_end(host) -i .dockertest.test

     http-request set-var(sess.var) req.hdr(Host),field(1,"."),lower

     http-request set-header X-Artifactory-Override-Base-Url https://%[hdr(host)]/artifactory
     use_backend test if n

     default_backend normal


backend test
    mode http
        server localhost 127.0.0.1:8081
    http-request set-path /artifactory/api/docker/%[var(sess.var)]%[path]

backend normal
    mode http
    server localhost 127.0.0.1:8081
